<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Microeconomﾃｩtrico Brasil 2025</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { box-shadow: 0 8px 16px rgba(0,0,0,0.08); border: none; border-radius: 15px; }
        .header-bg { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; padding: 3rem 0; margin-bottom: 2rem; }
        
        /* Estilos da Calculadora Instantﾃ｢nea */
        .result-box { 
            background-color: #ffffff; 
            border: 1px solid #dee2e6;
            border-left: 5px solid #198754;
            border-radius: 8px; 
            padding: 30px; 
            text-align: center; 
            display: none; 
            margin-top: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .result-value { font-size: 3.5rem; font-weight: 800; color: #198754; letter-spacing: -1px; margin: 10px 0; }
        .result-range { font-size: 1.15rem; color: #495057; background-color: #f8f9fa; padding: 10px; border-radius: 8px; display: inline-block; margin-top: 10px; border: 1px solid #e9ecef; }
        .badge-uf { background-color: #e7f1ff; color: #0d6efd; padding: 6px 12px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Botﾃｵes */
        .btn-calc { padding: 15px; font-size: 1.2rem; font-weight: 700; transition: all 0.3s; }
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }

        /* Estilos da Aba de Navegaﾃｧﾃ｣o */
        .nav-pills .nav-link { color: #495057; font-weight: 600; padding: 12px 25px; border-radius: 30px; margin: 0 5px; }
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }
        
        /* Container do Grﾃ｡fico */
        #chart-container { position: relative; height: 500px; width: 100%; margin-top: 20px; }
        
        .analysis-card { background: #fff; border-left: 4px solid #6f42c1; padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.95rem; }

        footer a { color: inherit; text-decoration: none; border-bottom: 1px dotted #6c757d; }
        footer a:hover { color: #0d6efd; border-bottom: 1px solid #0d6efd; }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    <div class="header-bg text-center">
        <h1 class="fw-bold display-5">腸 Microeconometria Aplicada</h1>
        <p class="lead opacity-90">Simuladores baseados na PNADc 2025 e Equaﾃｧﾃｵes de Mincer</p>
    </div>

    <div class="container pb-5 flex-grow-1">
        
        <ul class="nav nav-pills justify-content-center mb-5" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-calc-tab" data-bs-toggle="pill" data-bs-target="#pills-calc" type="button" role="tab">Calculadora Instantﾃ｢nea</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-sim-tab" data-bs-toggle="pill" data-bs-target="#pills-sim" type="button" role="tab">Custo de Oportunidade (Vida)</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-calc" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-7">
                        <div class="card p-4 p-md-5">
                            <form id="salaryForm">
                                <div class="row g-4 mb-4">
                                    <div class="col-12"><h5 class="text-primary fw-bold border-bottom pb-2">1. Seu Perfil</h5></div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-secondary">Idade</label>
                                        <input type="number" class="form-control form-control-lg" id="idade" value="30" min="14" max="80">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-secondary">Escolaridade</label>
                                        <select class="form-select form-select-lg" id="estudo">
                                            <option value="0">Sem instruﾃｧﾃ｣o</option>
                                            <option value="4">Fundamental Incompleto</option>
                                            <option value="9">Fundamental Completo</option>
                                            <option value="12" selected>Mﾃｩdio Completo</option>
                                            <option value="16">Superior Completo</option>
                                            <option value="18">Pﾃｳs-Graduaﾃｧﾃ｣o</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-secondary">Gﾃｪnero</label>
                                        <select class="form-select form-select-lg" id="sexo">
                                            <option value="homem">Homem</option>
                                            <option value="mulher">Mulher</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-secondary">Cor / Raﾃｧa</label>
                                        <select class="form-select form-select-lg" id="cor">
                                            <option value="branca">Branca / Amarela / Indﾃｭgena</option>
                                            <option value="preta">Preta / Parda</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-4 mb-4">
                                    <div class="col-12"><h5 class="text-primary fw-bold border-bottom pb-2 mt-3">2. Mercado de Trabalho</h5></div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold text-secondary">Setor</label>
                                        <select class="form-select form-select-lg" id="setor">
                                            <option value="1">Agricultura</option>
                                            <option value="3" selected>Indﾃｺstria de Transformaﾃｧﾃ｣o</option>
                                            <option value="6">Construﾃｧﾃ｣o Civil</option>
                                            <option value="7">Comﾃｩrcio</option>
                                            <option value="10">TI e Informaﾃｧﾃ｣o</option>
                                            <option value="11">Adm. Pﾃｺblica</option>
                                            <option value="12">Educaﾃｧﾃ｣o e Saﾃｺde</option>
                                            </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold text-secondary">Estado (UF)</label>
                                        <select class="form-select form-select-lg" id="uf">
                                            <option value="29">Bahia (BA)</option>
                                            <option value="35" selected>Sﾃ｣o Paulo (SP)</option>
                                            <option value="33">Rio de Janeiro (RJ)</option>
                                            <option value="31">Minas Gerais (MG)</option>
                                            <option value="53">Distrito Federal (DF)</option>
                                            </select>
                                    </div>
                                </div>
                                <div class="d-grid mt-5">
                                    <button type="button" class="btn btn-primary btn-calc shadow" onclick="calcularSalario()">Calcular Agora</button>
                                </div>
                            </form>
                            <div id="resultado" class="result-box">
                                <span class="badge-uf" id="badgeUF">Mﾃｩdia Estimada</span>
                                <div class="result-value" id="valorEstimado">R$ 0,00</div>
                                <div class="result-range">
                                    <span>Faixa provﾃ｡vel (95%):</span><br>
                                    <strong id="faixaMin" class="text-dark">R$ 0,00</strong> 
                                    <span class="text-muted mx-2">atﾃｩ</span> 
                                    <strong id="faixaMax" class="text-dark">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-sim" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="card p-4">
                            <h3 class="fw-bold text-primary mb-4">嶋 Anﾃ｡lise de Custo de Oportunidade</h3>
                            <p class="text-muted">Simule a renda acumulada dos 18 aos 65 anos comparando diferentes nﾃｭveis de escolaridade para o mesmo perfil demogrﾃ｡fico.</p>
                            
                            <div class="row g-3 p-3 bg-light rounded mb-4 border">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">Inflaﾃｧﾃ｣o Anual (%)</label>
                                    <input type="number" id="sim_inflacao" class="form-control" value="6.0" step="0.1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">UF</label>
                                    <select class="form-select" id="sim_uf">
                                        <option value="35" selected>Sﾃ｣o Paulo (SP)</option>
                                        <option value="29">Bahia (BA)</option>
                                        <option value="33">Rio de Janeiro (RJ)</option>
                                        <option value="53">Distrito Federal (DF)</option>
                                        <option value="31">Minas Gerais (MG)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">Setor</label>
                                    <select class="form-select" id="sim_setor">
                                        <option value="6" selected>Construﾃｧﾃ｣o Civil</option>
                                        <option value="3">Indﾃｺstria</option>
                                        <option value="10">TI e Informaﾃｧﾃ｣o</option>
                                        <option value="12">Educaﾃｧﾃ｣o e Saﾃｺde</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-success w-100 fw-bold" onclick="simularVida()">Gerar Grﾃ｡fico</button>
                                </div>
                            </div>

                            <div id="chart-container">
                                <canvas id="lifeChart"></canvas>
                            </div>

                            <div id="simulation-insights" class="mt-4">
                                </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="mt-auto py-4 bg-white border-top text-center text-secondary">
        <div class="container">
            <p class="mb-1 fw-bold text-dark">Joﾃ｣o Vitor dos Santos Sobrinho <span class="fw-normal text-muted">(Economia/UEFS)</span></p>
            <p class="mb-0 small">Projeto acadﾃｪmico de Microeconometria Aplicada.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let modelo = null;
        let myChart = null; // Variﾃ｡vel global para o grﾃ｡fico

        // Carregamento do JSON
        fetch('modelo_salario_coeficientes_2025_geral.json') 
            .then(response => {
                if (!response.ok) throw new Error("Erro HTTP: " + response.status);
                return response.json();
            })
            .then(data => {
                modelo = data;
                console.log("Modelo carregado:", modelo.meta_info);
            })
            .catch(error => {
                console.error('Erro ao carregar JSON:', error);
                alert('Erro: Modelo JSON nﾃ｣o encontrado na pasta.');
            });

        // ---------------------------------------------------------
        // FUNﾃﾃグ 1: CALCULADORA INSTANTﾃNEA (Lﾃｳgica Original)
        // ---------------------------------------------------------
        function calcularSalario() {
            if (!modelo) { alert("Carregando modelo..."); return; }

            const coef = modelo.coeficientes;
            let sigma = modelo.meta_info.sigma_resid || 0.65;
            if (sigma > 5) sigma = 0.65;

            const idade = parseFloat(document.getElementById('idade').value);
            const anosEstudo = parseFloat(document.getElementById('estudo').value);
            const sexo = document.getElementById('sexo').value;
            const cor = document.getElementById('cor').value;
            const setor = document.getElementById('setor').value;
            const uf = document.getElementById('uf').value;

            let experiencia = Math.max(0, idade - anosEstudo - 6);
            let experiencia2 = experiencia * experiencia;

            let score = (coef['const'] || 1.2) +
                        (coef['Anos_Estudo'] || 0) * anosEstudo +
                        (coef['Experiencia'] || 0) * experiencia +
                        (coef['Experiencia_2'] || 0) * experiencia2;

            if (sexo === 'mulher') score += (coef['d_mulher'] || 0);
            if (cor === 'preta') score += (coef['d_preto_pardo'] || 0);
            
            let chaveUF = `UF_${uf}`;
            if (coef[chaveUF]) score += coef[chaveUF];

            let chaveSetor = `setor_${setor}`;
            if (coef[chaveSetor]) score += coef[chaveSetor];

            if (coef['IMR']) score += coef['IMR'] * 0.6;

            let salarioMedio = Math.exp(score) * 180;
            let salarioMin = Math.exp(score - (1.96 * sigma)) * 180;
            let salarioMax = Math.exp(score + (1.96 * sigma)) * 180;

            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('valorEstimado').innerText = fmt.format(salarioMedio);
            document.getElementById('faixaMin').innerText = fmt.format(salarioMin);
            document.getElementById('faixaMax').innerText = fmt.format(salarioMax);
            
            const nomeUF = document.getElementById('uf').options[document.getElementById('uf').selectedIndex].text;
            document.getElementById('badgeUF').innerText = `Estimativa: ${nomeUF}`;

            const resultBox = document.getElementById('resultado');
            resultBox.style.display = 'block';
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ---------------------------------------------------------
        // FUNﾃﾃグ 2: SIMULAﾃﾃグ DE VIDA (Lﾃｳgica Python portada)
        // ---------------------------------------------------------
        function simularVida() {
            if (!modelo) { alert("Aguarde o carregamento do modelo."); return; }

            // 1. Coleta Inputs da Aba Simulaﾃｧﾃ｣o
            const inflacao = parseFloat(document.getElementById('sim_inflacao').value) / 100;
            const uf = document.getElementById('sim_uf').value;
            const setor = document.getElementById('sim_setor').value;
            const coef = modelo.coeficientes;

            // Perfis fixos para comparaﾃｧﾃ｣o (como no seu Python)
            const perfis = [
                { label: "Mﾃｩdio Completo", anos: 12, inicio: 18, color: '#440154', data: [] },
                { label: "Superior Completo", anos: 16, inicio: 23, color: '#21918c', data: [] },
                { label: "Mestrado/Doutorado", anos: 18, inicio: 30, color: '#5ec962', data: [] }
            ];

            const labelsIdade = [];
            const salariosPorAno = 13;
            
            // 2. Loop de Simulaﾃｧﾃ｣o (18 a 65 anos)
            for (let idade = 18; idade <= 65; idade++) {
                labelsIdade.push(idade);

                perfis.forEach(perfil => {
                    let acumuladoAnterior = perfil.data.length > 0 ? perfil.data[perfil.data.length - 1] : 0;
                    
                    if (idade < perfil.inicio) {
                        perfil.data.push(acumuladoAnterior); // Ainda nﾃ｣o ganha, mantﾃｩm acumulado (custo oportunidade)
                    } else {
                        // Calcula Experiﾃｪncia Minceriana
                        let exp = Math.max(0, idade - perfil.anos - 6);
                        let exp2 = exp * exp;

                        // Score Log-Linear Base
                        let score = (coef['const'] || 0) +
                                    (coef['Anos_Estudo'] || 0) * perfil.anos +
                                    (coef['Experiencia'] || 0) * exp +
                                    (coef['Experiencia_2'] || 0) * exp2;

                        // Controles fixos (Homem, Branco como base no exemplo Python, mas adicionando UF/Setor)
                        if (coef[`UF_${uf}`]) score += coef[`UF_${uf}`];
                        if (coef[`setor_${setor}`]) score += coef[`setor_${setor}`];
                        if (coef['IMR']) score += coef['IMR'] * 0.6;

                        // Salﾃ｡rio Real Mensal
                        let salarioReal = Math.exp(score) * 180;

                        // Aplica Inflaﾃｧﾃ｣o Composta (desde os 18 anos)
                        let anosInflacao = idade - 18;
                        let fatorInflacao = Math.pow(1 + inflacao, anosInflacao);
                        let salarioNominal = salarioReal * fatorInflacao;

                        // Acumula
                        let rendaAnual = salarioNominal * salariosPorAno;
                        perfil.data.push(acumuladoAnterior + rendaAnual);
                    }
                });
            }

            // 3. Detecﾃｧﾃ｣o de "Crossover" (Pontos de Virada)
            const insightsContainer = document.getElementById('simulation-insights');
            insightsContainer.innerHTML = '';
            const points = []; // Para desenhar no grﾃ｡fico

            const comparacoes = [
                { maior: perfis[1], menor: perfis[0] }, // Superior > Mﾃｩdio
                { maior: perfis[2], menor: perfis[1] }  // Mestrado > Superior
            ];

            comparacoes.forEach(comp => {
                // Encontra a primeira idade onde a curva maior ultrapassa a menor
                // Ignora os primeiros anos onde ambos podem ser zero ou custos iniciais
                for (let i = 0; i < labelsIdade.length; i++) {
                    // Sﾃｳ verifica se a idade for maior que o inicio da carreira do "maior"
                    if (labelsIdade[i] > comp.maior.inicio && comp.maior.data[i] > comp.menor.data[i]) {
                        
                        // Cria anotaﾃｧﾃ｣o visual e texto
                        let idadeVirada = labelsIdade[i];
                        let valorVirada = comp.maior.data[i];

                        // Adiciona HTML
                        let html = `
                            <div class="analysis-card shadow-sm">
                                <strong>笨 ${comp.maior.label} ultrapassa ${comp.menor.label}</strong><br>
                                Idade de virada: <span class="text-primary fw-bold">${idadeVirada} anos</span><br>
                                Patrimﾃｴnio Acumulado: R$ ${(valorVirada/1000000).toFixed(2)} Milhﾃｵes
                            </div>`;
                        insightsContainer.innerHTML += html;

                        // Adiciona ponto para o grﾃ｡fico
                        points.push({ x: idadeVirada, y: valorVirada, label: `${comp.maior.label} >` });
                        break; // Para apﾃｳs encontrar o primeiro ponto
                    }
                }
            });

            renderizarGrafico(labelsIdade, perfis, points);
        }

        // ---------------------------------------------------------
        // FUNﾃﾃグ 3: RENDERIZAR GRﾃ：ICO (Chart.js)
        // ---------------------------------------------------------
        function renderizarGrafico(labels, datasets, points) {
            const ctx = document.getElementById('lifeChart').getContext('2d');

            if (myChart) myChart.destroy();

            // Dataset das linhas
            const chartDatasets = datasets.map(d => ({
                label: d.label,
                data: d.data,
                borderColor: d.color,
                backgroundColor: d.color,
                borderWidth: 3,
                pointRadius: 0, // Linha limpa
                tension: 0.4 // Curva suave
            }));

            // Dataset dos pontos de virada (Scatter)
            const scatterData = points.map(p => ({ x: p.x, y: p.y }));
            if (scatterData.length > 0) {
                chartDatasets.push({
                    label: 'Ponto de Virada',
                    data: scatterData,
                    type: 'scatter',
                    backgroundColor: 'red',
                    pointRadius: 6,
                    pointHoverRadius: 8
                });
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: { display: true, text: 'Acumulado de Renda Vitalﾃｭcia (Nominal)', font: { size: 16 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Idade' },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: 'Acumulado (R$)' },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) return 'R$ ' + (value/1000000).toFixed(1) + ' Mi';
                                    if (value >= 1000) return 'R$ ' + (value/1000).toFixed(0) + ' k';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
